<VirtualHost *:80>

    ServerName rightsstatements.org
    ServerAlias *.rightsstatements.org

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI}

</VirtualHost>

<VirtualHost *:443>

    ServerName rightsstatements.org
    ServerAlias *.rightsstatements.org

    SSLEngine on
    SSLCertificateFile {{ proxy_ssl_cert }}
    SSLCertificateKeyFile {{ proxy_ssl_key }}
    SSLCertificateChainFile {{ proxy_ssl_chain }}

    SSLProxyEngine on
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^/(.*)$ https://%1/$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^(.+)\.rightsstatements\.org$
    RewriteCond %{REQUEST_URI} !^/vocab
    RewriteCond %{REQUEST_URI} !^/page
    RewriteCond %{REQUEST_URI} !^/data
    RewriteRule ^/(.*)$ https://%1.netlify.com/$1 [P,L]

    ProxyPass /vocab http://{{ rights_app_server }}:{{ rights_app_port }}/vocab
    ProxyPassReverse /vocab http://{{ rights_app_server }}:{{ rights_app_port }}/vocab
    ProxyPass /page http://{{ rights_app_server }}:{{ rights_app_port }}/page
    ProxyPassReverse /page http://{{ rights_app_server }}:{{ rights_app_port }}/page
    ProxyPass /data http://{{ rights_app_server }}:{{ rights_app_port }}/data
    ProxyPassReverse /data http://{{ rights_app_server }}:{{ rights_app_port }}/data

    ProxyPass / https://rightsstatements.netlify.com/
    ProxyPassReverse / https://rightsstatements.netlify.com/

</VirtualHost>
